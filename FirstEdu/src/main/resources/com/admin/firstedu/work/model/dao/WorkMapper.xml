<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.admin.firstedu.work.model.dao.WorkMapper">

	<!-- resultMap -->
	<!-- 업무 보드 DTO -->
	<resultMap id="workBoardResultMap" type="WorkBoardDTO">
		<id column="BOARD_NO" property="boardNo"/>
		<result column="TITLE" property="title"/>
		<result column="CREATOR" property="creator"/>
	</resultMap>
	
	<!-- 선생님 DTO -->
	<resultMap id="teacherResultMap" type="TeacherDTO">
	    <id column="TEACHER_NO" property="no" />
	    <result column="JOB_CODE" property="jobCode" />
	    <result column="TEACHER_ID" property="id" />
	    <result column="TEACHER_PWD" property="pwd" />
	    <result column="TEACHER_NAME" property="name" />
	    <result column="TEACHER_EMAIL" property="email" />
	    <result column="TEACHER_GENDER" property="gender" />
	    <result column="TEACHER_PHONE" property="phone" />
	    <result column="TEACHER_ADDRESS" property="address" />
	    <result column="TEACHER_ROLE" property="role" />
	    <result column="HIRE_DATE" property="hireDate" />
	    <result column="ENT_DATE" property="endDate" />
	    <result column="TEACHER_STATUS" property="status" />
	</resultMap>
	
	<!-- 업무 보드 공유자 모든 정보 -->
	<resultMap id="WorkBoardMemberFullInfoResultMap" type="WorkBoardMemberFullInfoDTO">
		<result column="FAVORITE_YN" property="favoriteYn"/>
		<association resultMap="workBoardResultMap" property="board"/>
		<association resultMap="teacherResultMap" property="teacher"/>
	</resultMap>
	
	<!--  업무 보드 전체 정보 조회용 -->
	<resultMap id="workBoardFullInfoResultMap" type="WorkBoardFullInfoDTO">
		<id column="BOARD_NO" property="boardNo"/>
		<result column="TITLE" property="title"/>
		<result column="CREATOR" property="creator"/>
		<result column="IS_FAVORITE" property="isFavorite"/>
		<collection resultMap="WorkBoardMemberFullInfoResultMap" property="memberList"/>
	</resultMap>
	
	<!-- 업무 보드 생성 시 정보 조회용 -->
	<resultMap id="workBoardAndTeacherResultMap" type="WorkBoardAndTeacherDTO">
		<id column="BOARD_NO" property="boardNo"/>
		<result column="TITLE" property="title"/>
		<association resultMap="teacherResultMap" property="creator"/>
	</resultMap>
	
	<!-- 색상 DTO -->
	<resultMap id="colorResultMap" type="ColorDTO">
		<id column="COLOR_NO" property="no"/>
		<result column="COLOR_NAME" property="name"/>
		<result column="COLOR_CODE_HEX" property="codeHex"/>
	</resultMap>
	
	<!-- 업무 카드 태그 색상 포함 정보 조회용 -->
	<resultMap id="WorkCardTagAndColorResultMap" type="WorkCardTagAndColorDTO">
		<id column="TAG_NO" property="tagNo"/>
		<result column="TAG_NAME" property="tagName"/>
		<result column="CARD_NO" property="cardNo"/>
		<association resultMap="colorResultMap" property="color"/>
	</resultMap>
	
	<!-- 업무 카드 담당자 조회용 -->
	<resultMap id="WorkCardMemberAndTeacherResultMap" type="WorkCardMemberAndTeacherDTO">
		<result column="CARD_NO" property="cardNo"/>
		<association resultMap="teacherResultMap" property="teacher"/>
	</resultMap>
	
	<!-- 업무 카드 목록에서 표시되는 정보 조회용 -->
	<resultMap id="workCardSummaryInfoResultMap" type="WorkCardSummaryInfoDTO">
		<id column="CARD_NO" property="cardNo"/>
		<result column="CARD_TITLE" property="cardTitle"/>
		<result column="DUE_DATE" property="dueDate"/>
		<collection resultMap="WorkCardTagAndColorResultMap" property="tagList"/>
		<collection resultMap="WorkCardMemberAndTeacherResultMap" property="cardMemberList"/>
	</resultMap>
	
	<!-- 업무 카드 목록 조회용 -->
	<resultMap id="workCardListInfoResultMap" type="WorkCardListInfoDTO">
		<id column="LIST_NO" property="listNo"/>
		<result column="LIST_TYPE" property="listType"/>
		<result column="BOARD_NO" property="boardNo"/>
		<result column="ORDER_NO" property="orderNo"/>
		<result column="LIST_NAME" property="listName"/>
		<collection resultMap="workCardSummaryInfoResultMap" property="workCardList"/>
	</resultMap>
	
	
	
	
	<!-- 쿼리문 -->
	<!-- 업무 보드 리스트 조회 -->
	<select id="selectWorkBoardList" parameterType="TeacherDTO" resultMap="workBoardFullInfoResultMap">
		SELECT
		       A.BOARD_NO
		     , A.TITLE
		     , A.CREATOR
		     , (SELECT D.FAVORITE_YN
		         FROM TBL_WORK_BOARD_MEMBER D
		        WHERE D.BOARD_NO = A.BOARD_NO
		          AND D.TEACHER_NO = #{ no }
		       ) AS IS_FAVORITE
		     , B.TEACHER_NO
		     , C.TEACHER_NAME
		  FROM TBL_WORK_BOARD A
		  JOIN TBL_WORK_BOARD_MEMBER B ON (A.BOARD_NO = B.BOARD_NO)
		  JOIN TBL_TEACHER C ON (B.TEACHER_NO = C.TEACHER_NO)
         WHERE A.BOARD_NO IN (SELECT A.BOARD_NO
                                FROM TBL_WORK_BOARD_MEMBER A
                               WHERE A.TEACHER_NO = #{ no }
                             )
         ORDER BY A.BOARD_NO
	</select>

	<!-- 업무 보드 등록 -->
	<insert id="insertWorkBoard" parameterType="WorkBoardDTO">
		INSERT
		  INTO TBL_WORK_BOARD A
		(
		  A.BOARD_NO
		, A.TITLE
		, A.CREATOR
		)
		VALUES
		(
		  SEQ_BOARD_NO.NEXTVAL
		, #{ title }
		, #{ creator }
		)
	</insert>
	
	<!-- 등록한 업무 보드 정보 조회 -->
	<select id="selectRegisteredWorkBoard" resultMap="workBoardAndTeacherResultMap">
		SELECT
		       A.BOARD_NO
		     , A.TITLE
		     , A.CREATOR
		     , B.TEACHER_NAME
		  FROM TBL_WORK_BOARD A
		  JOIN TBL_TEACHER B ON (A.CREATOR = B.TEACHER_NO)
         WHERE A.BOARD_NO = GET_CURR_BOARD_NO
	</select>
	
	<!-- 업무 보드 상세 페이지용 정보 조회 -->
	<select id="selectWorkBoard" parameterType="_int" resultMap="workBoardFullInfoResultMap">
		SELECT
		       A.BOARD_NO
		     , A.TITLE
		     , A.CREATOR
		     , (SELECT D.FAVORITE_YN
		         FROM TBL_WORK_BOARD_MEMBER D
		        WHERE D.BOARD_NO = A.BOARD_NO
		          AND D.TEACHER_NO = #{ teacherNo }
		       ) AS IS_FAVORITE
		     , B.TEACHER_NO
		     , C.TEACHER_NAME
		  FROM TBL_WORK_BOARD A
		  JOIN TBL_WORK_BOARD_MEMBER B ON (A.BOARD_NO = B.BOARD_NO)
		  JOIN TBL_TEACHER C ON (B.TEACHER_NO = C.TEACHER_NO)
         WHERE A.BOARD_NO = #{ boardNo }
         ORDER BY A.BOARD_NO
	</select>
	
	<!-- 업무 카드 목록 조회 -->
	<select id="selectWorkCardList" parameterType="_int" resultMap="workCardListInfoResultMap">
		SELECT
               A.LIST_NO
             , A.LIST_TYPE
             , A.ORDER_NO
             , A.LIST_NAME
		     , B.CARD_NO
		     , B.CARD_TITLE
		     , B.DUE_DATE
             , C.TAG_NO
             , C.TAG_NAME
             , D.COLOR_CODE_HEX
             , F.TEACHER_NAME
          FROM TBL_WORK_BOARD_LIST A
          JOIN TBL_WORK_CARD B ON (A.LIST_NO = B.LIST_NO)
          LEFT JOIN TBL_WORK_CARD_TAG C ON (B.CARD_NO = C.CARD_NO)
          LEFT JOIN TBL_COLOR D ON (C.COLOR_NO = D.COLOR_NO)
          LEFT JOIN TBL_WORK_CARD_MEMBER E ON (B.CARD_NO = E.CARD_NO)
          LEFT JOIN TBL_TEACHER F ON (E.TEACHER_NO = F.TEACHER_NO)
         WHERE A.BOARD_NO = #{ boardNo }
         ORDER BY CARD_NO
	</select>
	
</mapper>